<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador ‚Äì Sistema de Tutor√≠as UNSAAC</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal.show {
      display: flex;
    }

    /* TOAST NOTIFICATIONS */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      min-width: 300px;
      padding: 16px 20px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease-out;
      cursor: pointer;
    }

    .toast.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .toast.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: 1px solid rgba(255,255,255,0.2);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOut 0.3s ease-out forwards;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-card {
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeInUp 0.5s ease-out;
    }

    .user-card {
      transition: all 0.3s ease;
    }

    .user-card:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(5px);
    }
  </style>
</head>

<body class="min-h-screen p-6 text-white">

  <!-- TOAST CONTAINER -->
  <div id="toast-container" class="toast-container"></div>

  <div class="w-full max-w-7xl mx-auto flex rounded-3xl glass-card shadow-2xl overflow-hidden">

    <aside class="w-72 border-r border-white/20 p-6 flex flex-col justify-between bg-black/20">
      <div>
        <div class="flex items-center space-x-3 mb-8">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 
                      flex items-center justify-center text-2xl font-bold text-white shadow-lg">
            A
          </div>
          <div>
            <p class="text-xs uppercase tracking-widest text-yellow-300/90 font-semibold">Administrador</p>
            <p id="admin-nombre" class="text-sm font-bold text-white">‚Äî</p>
          </div>
        </div>

        <nav class="space-y-2 text-sm">
          <button class="tab-btn w-full text-left px-4 py-3 rounded-xl bg-white/20 text-white font-semibold shadow-lg" data-target="sec-dashboard">
            üìä Panel General
          </button>
          <button class="tab-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/10 text-white/80 font-semibold transition-all" data-target="sec-usuarios">
            üë• Gesti√≥n de Usuarios
          </button>
          <button class="tab-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/10 text-white/80 font-semibold transition-all" data-target="sec-asignaciones">
            üîÑ Asignar Tutores
          </button>
        </nav>
      </div>

      <button id="logout-btn" class="w-full px-4 py-3 mt-6 rounded-xl bg-red-500/90 hover:bg-red-600 text-sm font-bold transition-all shadow-lg">
        üö™ Cerrar sesi√≥n
      </button>
    </aside>

    <main class="flex-1 p-8 space-y-8 bg-white/5 overflow-y-auto max-h-screen">
      <header class="animate-fade-in">
        <h1 class="text-4xl font-bold text-white mb-2 drop-shadow-lg">Panel del Administrador</h1>
        <p class="text-white/70 text-base">Sistema de Tutor√≠as UNSAAC</p>
      </header>

      <!-- DASHBOARD -->
      <section id="sec-dashboard" class="section space-y-6">
        <!-- Stats Cards principales con iconos grandes -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="stat-card glass-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-start justify-between mb-4">
              <div class="text-5xl">üë®‚Äçüéì</div>
              <div class="bg-blue-500/20 p-2 rounded-lg">
                <p class="text-xs font-bold text-blue-300">TOTAL</p>
              </div>
            </div>
            <p class="text-sm uppercase tracking-wider text-white/60 mb-1 font-semibold">Estudiantes</p>
            <p id="card-estudiantes" class="text-5xl font-black text-white">‚Äî</p>
          </div>

          <div class="stat-card glass-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-start justify-between mb-4">
              <div class="text-5xl">üë®‚Äçüè´</div>
              <div class="bg-emerald-500/20 p-2 rounded-lg">
                <p class="text-xs font-bold text-emerald-300">ACTIVOS</p>
              </div>
            </div>
            <p class="text-sm uppercase tracking-wider text-white/60 mb-1 font-semibold">Tutores</p>
            <p id="card-tutores" class="text-5xl font-black text-white">‚Äî</p>
          </div>

          <div class="stat-card glass-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-start justify-between mb-4">
              <div class="text-5xl">üìÖ</div>
              <div class="bg-amber-500/20 p-2 rounded-lg">
                <p class="text-xs font-bold text-amber-300">ACTIVOS</p>
              </div>
            </div>
            <p class="text-sm uppercase tracking-wider text-white/60 mb-1 font-semibold">Cronogramas</p>
            <p id="card-cronos" class="text-5xl font-black text-white">‚Äî</p>
          </div>

          <div class="stat-card glass-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-start justify-between mb-4">
              <div class="text-5xl">üìö</div>
              <div class="bg-purple-500/20 p-2 rounded-lg">
                <p class="text-xs font-bold text-purple-300">TOTAL</p>
              </div>
            </div>
            <p class="text-sm uppercase tracking-wider text-white/60 mb-1 font-semibold">Tutor√≠as</p>
            <p id="card-tutorias" class="text-5xl font-black text-white">‚Äî</p>
          </div>
        </div>

        <!-- Resumen visual con porcentajes y barras -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="glass-card rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <span class="text-2xl">üìä</span> Resumen del Sistema
            </h3>
            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-white/80 font-semibold">Estudiantes Activos</span>
                  <span id="porcentaje-estudiantes" class="text-white font-bold">‚Äî</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                  <div id="barra-estudiantes" class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-white/80 font-semibold">Tutores Disponibles</span>
                  <span id="porcentaje-tutores" class="text-white font-bold">‚Äî</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                  <div id="barra-tutores" class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between mb-2">
                  <span class="text-white/80 font-semibold">Cronogramas Vigentes</span>
                  <span id="porcentaje-cronos" class="text-white font-bold">‚Äî</span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                  <div id="barra-cronos" class="bg-gradient-to-r from-amber-400 to-amber-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="glass-card rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <span class="text-2xl">üéØ</span> Estad√≠sticas R√°pidas
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white/10 rounded-xl p-4 text-center">
                <p class="text-3xl font-black text-white" id="ratio-tutor">‚Äî</p>
                <p class="text-xs text-white/70 mt-1 font-semibold">Estudiantes por Tutor</p>
              </div>
              <div class="bg-white/10 rounded-xl p-4 text-center">
                <p class="text-3xl font-black text-white" id="promedio-tutorias">‚Äî</p>
                <p class="text-xs text-white/70 mt-1 font-semibold">Tutor√≠as por Cronograma</p>
              </div>
              <div class="bg-white/10 rounded-xl p-4 text-center col-span-2">
                <p class="text-3xl font-black text-white" id="total-sistema">‚Äî</p>
                <p class="text-xs text-white/70 mt-1 font-semibold">Total de Usuarios en el Sistema</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- GESTI√ìN DE USUARIOS -->
      <section id="sec-usuarios" class="section hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-white drop-shadow-lg">Gesti√≥n de Usuarios</h2>
          <button id="btn-nuevo-usuario" class="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 font-bold shadow-xl transition-all hover:scale-105">
            ‚ûï Crear Usuario
          </button>
        </div>
        <div id="lista-usuarios" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
          <p class="text-center text-white/60">Cargando usuarios...</p>
        </div>
      </section>

      <!-- ASIGNACIONES -->
      <section id="sec-asignaciones" class="section hidden">
        <h2 class="text-3xl font-bold text-white mb-6 drop-shadow-lg">Asignaci√≥n de Tutorados</h2>
        <button id="btn-asignar" class="px-6 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 font-bold shadow-xl transition-all hover:scale-105">
          ‚ûï Nueva Asignaci√≥n
        </button>
        <div id="resultado-asignacion" class="mt-4 text-white/90"></div>
      </section>
    </main>
  </div>

  <!-- MODAL CREAR USUARIO -->
  <div id="modal-user" class="modal">
    <div class="glass-card rounded-2xl p-8 w-96 shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-white">Crear Usuario</h2>
      <input id="u-nombre" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-3 placeholder-white/50" placeholder="Nombre">
      <input id="u-apellido" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-3 placeholder-white/50" placeholder="Apellido">
      <input id="u-email" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-3 placeholder-white/50" placeholder="Email">
      <input id="u-pass" type="password" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-4 placeholder-white/50" placeholder="Contrase√±a">
      <label class="text-sm text-white/80 font-semibold">Rol</label>
      <select id="u-rol" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-6">
        <option value="1">Administrador</option>
        <option value="2">Tutor</option>
        <option value="3">Alumno</option>
        <option value="4">Verificador</option>
      </select>
      <div class="flex justify-end gap-3">
        <button class="btn-cancelar px-5 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-semibold transition-all">Cancelar</button>
        <button id="crear-usuario" class="px-5 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold shadow-lg transition-all">Crear</button>
      </div>
    </div>
  </div>

  <!-- MODAL ASIGNAR -->
  <div id="modal-asignar" class="modal">
    <div class="glass-card rounded-2xl p-8 w-96 shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-white">Asignar Tutor a Alumno</h2>
      <label class="text-sm text-white/80 font-semibold">Alumno</label>
      <select id="sel-alumnos" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-4"></select>
      <label class="text-sm text-white/80 font-semibold">Tutor</label>
      <select id="sel-tutores" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-4"></select>
      <label class="text-sm text-white/80 font-semibold">Materia</label>
      <select id="sel-materias" class="w-full p-3 rounded-xl bg-white/10 text-white border border-white/20 mb-6"></select>
      <div class="flex justify-end gap-3">
        <button class="btn-cancelar px-5 py-2 rounded-xl bg-white/10 hover:bg-white/20 font-semibold transition-all">Cancelar</button>
        <button id="asignar-btn" class="px-5 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold shadow-lg transition-all">Asignar</button>
      </div>
    </div>
  </div>

  <script>
    const API = "/api/admin";

    const admin = JSON.parse(localStorage.getItem("userData"));
    if (!admin || admin.rol !== 1) window.location.href = "/";

    document.getElementById("admin-nombre").textContent = admin.nombre + " " + (admin.apellido || "");

    document.getElementById("logout-btn").onclick = () => {
      localStorage.removeItem("userData");
      window.location.href = "/";
    };

    // SISTEMA DE NOTIFICACIONES TOAST
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
      toast.innerHTML = `
        <span class="text-2xl">${icon}</span>
        <span>${message}</span>
      `;
      
      container.appendChild(toast);
      
      // Auto-cerrar despu√©s de 3 segundos
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => {
          container.removeChild(toast);
        }, 300);
      }, 3000);

      // Permitir cerrar al hacer clic
      toast.onclick = () => {
        toast.classList.add('hiding');
        setTimeout(() => {
          container.removeChild(toast);
        }, 300);
      };
    }

    // TAB NAVIGATION
    const tabBtns = document.querySelectorAll(".tab-btn");
    const sections = document.querySelectorAll(".section");

    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        sections.forEach(sec => sec.classList.add("hidden"));
        document.getElementById(target).classList.remove("hidden");
        tabBtns.forEach(b => {
          b.classList.remove("bg-white/20", "shadow-lg");
          b.classList.add("hover:bg-white/10", "text-white/80");
        });
        btn.classList.add("bg-white/20", "shadow-lg", "text-white");
        btn.classList.remove("hover:bg-white/10", "text-white/80");
      });
    });

    async function fetchJSON(url, options = {}) {
      const r = await fetch(url, options);
      return r.json();
    }

    // DASHBOARD CARDS CON ANIMACIONES
    async function cargarResumen() {
      const data = await fetchJSON(`${API}/resumen`);
      
      // N√∫meros principales
      document.getElementById("card-estudiantes").textContent = data.estudiantes;
      document.getElementById("card-tutores").textContent = data.tutores;
      document.getElementById("card-cronos").textContent = data.cronogramas;
      document.getElementById("card-tutorias").textContent = data.tutorias;

      // Estad√≠sticas calculadas
      const totalUsuarios = data.estudiantes + data.tutores + 1; // +1 por el admin
      const ratioTutorAlumno = data.tutores > 0 ? Math.round(data.estudiantes / data.tutores) : 0;
      const promTutorias = data.cronogramas > 0 ? Math.round(data.tutorias / data.cronogramas) : 0;

      document.getElementById("total-sistema").textContent = totalUsuarios;
      document.getElementById("ratio-tutor").textContent = ratioTutorAlumno;
      document.getElementById("promedio-tutorias").textContent = promTutorias;

      // Barras de progreso animadas (normalizado a 100%)
      const maxValor = Math.max(data.estudiantes, data.tutores, data.cronogramas);
      
      setTimeout(() => {
        const porcEstudiantes = (data.estudiantes / maxValor * 100).toFixed(0);
        const porcTutores = (data.tutores / maxValor * 100).toFixed(0);
        const porcCronos = (data.cronogramas / maxValor * 100).toFixed(0);

        document.getElementById("barra-estudiantes").style.width = porcEstudiantes + "%";
        document.getElementById("barra-tutores").style.width = porcTutores + "%";
        document.getElementById("barra-cronos").style.width = porcCronos + "%";

        document.getElementById("porcentaje-estudiantes").textContent = data.estudiantes;
        document.getElementById("porcentaje-tutores").textContent = data.tutores;
        document.getElementById("porcentaje-cronos").textContent = data.cronogramas;
      }, 200);
    }

    // LISTA USUARIOS MEJORADA
    async function cargarUsuarios() {
      const data = await fetchJSON(`${API}/usuarios`);
      const cont = document.getElementById("lista-usuarios");
      
      if(data.usuarios.length === 0) {
        cont.innerHTML = '<p class="text-center text-white/60">No hay usuarios registrados</p>';
        return;
      }

      cont.innerHTML = data.usuarios.map(u => `
        <div class="user-card glass-card rounded-xl px-6 py-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white font-bold text-lg">
                ${u.nombre.charAt(0)}${u.apellido.charAt(0)}
              </div>
              <div>
                <p class="text-white font-bold text-lg">${u.nombre} ${u.apellido}</p>
                <p class="text-sm text-white/70">${u.email}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="px-3 py-1 rounded-full text-xs font-bold ${
                u.rol === 1 ? 'bg-yellow-500/20 text-yellow-300' :
                u.rol === 2 ? 'bg-emerald-500/20 text-emerald-300' :
                u.rol === 3 ? 'bg-blue-500/20 text-blue-300' :
                'bg-purple-500/20 text-purple-300'
              }">
                ${u.nombre_rol}
              </span>
            </div>
          </div>
        </div>
      `).join("");
    }

    // MODALES
    const modalUser = document.getElementById("modal-user");
    const modalAsignar = document.getElementById("modal-asignar");

    document.getElementById("btn-nuevo-usuario").onclick = () => modalUser.classList.add("show");
    document.getElementById("btn-asignar").onclick = async () => {
      modalAsignar.classList.add("show");
      
      const [alumnos, tutores, materias] = await Promise.all([
        fetchJSON(`${API}/alumnos/disponibles`),
        fetchJSON(`${API}/tutores/disponibles`),
        fetchJSON(`${API}/materias`)
      ]);

      document.getElementById("sel-alumnos").innerHTML = (alumnos || []).map(a => 
        `<option value="${a.id_alumno}">${a.codigo_estudiante || ''} - ${a.nombre} ${a.apellido}</option>`
      ).join("");
      
      document.getElementById("sel-tutores").innerHTML = (tutores || []).map(t => 
        `<option value="${t.id_tutor}">${t.codigo_docente || ''} - ${t.nombre} ${t.apellido}</option>`
      ).join("");
      
      document.getElementById("sel-materias").innerHTML = (materias || []).map(m => 
        `<option value="${m.id_materia}">${m.codigo_materia || ''} - ${m.nombre_materia}</option>`
      ).join("");
    };

    document.querySelectorAll(".btn-cancelar").forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        btn.closest(".modal").classList.remove("show");
      };
    });

    // CREAR USUARIO
    document.getElementById("crear-usuario").onclick = async () => {
      const payload = {
        nombre: document.getElementById("u-nombre").value,
        apellido: document.getElementById("u-apellido").value,
        email: document.getElementById("u-email").value,
        password: document.getElementById("u-pass").value,
        rol: Number(document.getElementById("u-rol").value)
      };

      if (!payload.nombre || !payload.apellido || !payload.email || !payload.password) {
        showToast("Por favor completa todos los campos", "error");
        return;
      }

      try {
        const res = await fetchJSON(`${API}/usuarios`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        showToast(res.message || "Usuario creado exitosamente", "success");
        modalUser.classList.remove("show");
        
        // Limpiar formulario
        document.getElementById("u-nombre").value = "";
        document.getElementById("u-apellido").value = "";
        document.getElementById("u-email").value = "";
        document.getElementById("u-pass").value = "";
        
        cargarUsuarios();
        cargarResumen();
      } catch (error) {
        showToast("Error al crear usuario", "error");
      }
    };

    // ASIGNAR
    document.getElementById("asignar-btn").onclick = async () => {
      const payload = {
        id_alumno: Number(document.getElementById("sel-alumnos").value),
        id_tutor: Number(document.getElementById("sel-tutores").value),
        id_materia: Number(document.getElementById("sel-materias").value)
      };

      if(!payload.id_alumno || !payload.id_tutor || !payload.id_materia) {
        showToast("Aseg√∫rate de tener seleccionados Alumno, Tutor y Materia", "error");
        return;
      }

      try {
        const res = await fetchJSON(`${API}/asignar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        showToast(res.message || "Asignaci√≥n exitosa", "success");
        modalAsignar.classList.remove("show");
        cargarResumen();
      } catch (error) {
        showToast("Error al realizar la asignaci√≥n", "error");
      }
    };

    // INICIALIZAR
    cargarResumen();
    cargarUsuarios();
  </script>
</body>
</html>