<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-950 bg-gradient-to-br from-slate-950 via-slate-900 to-sky-900 text-slate-100">

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="min-h-screen flex items-center justify-center px-4 py-6">

    <!-- LAYOUT: SIDEBAR + MAIN -->
    <div class="w-full max-w-6xl flex rounded-3xl border border-sky-500/30 bg-slate-950/60 backdrop-blur-xl shadow-[0_0_40px_rgba(56,189,248,0.35)] overflow-hidden">

      <!-- ===================== SIDEBAR ===================== -->
      <aside class="w-64 border-r border-sky-500/20 p-6 flex flex-col justify-between bg-slate-950/60">

        <!-- Perfil -->
        <div>
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-sky-500 to-cyan-400 flex items-center justify-center text-xl font-bold">
              T
            </div>
            <div>
              <p class="text-xs uppercase tracking-widest text-sky-400/80">Panel Tutor</p>
              <p id="tutor-email" class="text-sm font-semibold text-slate-50">tutor@unsaac.edu.pe</p>
            </div>
          </div>

          <nav class="space-y-2 text-sm">
            <button
              class="tab-btn w-full text-left px-3 py-2 rounded-xl bg-sky-500/20 text-sky-300 font-medium border border-sky-400/40"
              data-target="sec-estudiantes"
            >
              üë• Mis estudiantes
            </button>
            <button
              class="tab-btn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-800/80 text-slate-200 font-medium border border-transparent"
              data-target="sec-tutorias"
            >
              üìÖ Tutor√≠as
            </button>
            <button
              class="tab-btn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-800/80 text-slate-200 font-medium border border-transparent"
              data-target="sec-feedback"
            >
              üí¨ Retroalimentaciones
            </button>
            <button
              class="tab-btn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-800/80 text-slate-200 font-medium border border-transparent"
              data-target="sec-registro"
            >
              ‚ûï Registrar tutor√≠a
            </button>
          </nav>
        </div>

        <!-- Logout -->
        <button
          id="logout-btn"
          class="mt-6 w-full px-3 py-2 rounded-xl bg-rose-600/90 hover:bg-rose-500 text-sm font-semibold text-white transition"
        >
          Cerrar sesi√≥n
        </button>

      </aside>

      <!-- ===================== MAIN ===================== -->
      <main class="flex-1 p-6 md:p-8 space-y-6">

        <!-- Encabezado -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-50">
              Sistema de Informaci√≥n de Tutor√≠as
            </h1>
            <p class="text-xs md:text-sm text-slate-400">
              Gesti√≥n acad√©mica, personal y profesional de tus tutorandos.
            </p>
          </div>

          <div class="grid grid-cols-3 gap-3 text-xs">
            <div class="rounded-2xl border border-sky-400/30 bg-slate-900/70 px-3 py-2">
              <p class="text-[10px] uppercase tracking-widest text-sky-400/80">Estudiantes</p>
              <p id="count-estudiantes" class="text-lg font-semibold text-slate-50">‚Äî</p>
            </div>
            <div class="rounded-2xl border border-emerald-400/30 bg-slate-900/70 px-3 py-2">
              <p class="text-[10px] uppercase tracking-widest text-emerald-300/80">Tutor√≠as</p>
              <p id="count-tutorias" class="text-lg font-semibold text-slate-50">‚Äî</p>
            </div>
            <div class="rounded-2xl border border-fuchsia-400/30 bg-slate-900/70 px-3 py-2">
              <p class="text-[10px] uppercase tracking-widest text-fuchsia-300/80">Feedback</p>
              <p id="count-feedback" class="text-lg font-semibold text-slate-50">‚Äî</p>
            </div>
          </div>
        </header>

        <!-- ========== SECCI√ìN: ESTUDIANTES ========== -->
        <section id="sec-estudiantes" class="space-y-4">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <h2 class="text-lg font-semibold text-slate-50">Mis estudiantes</h2>
            <input
              id="search-estudiante"
              type="text"
              placeholder="Buscar por nombre o c√≥digo..."
              class="w-full md:w-72 px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-sky-400"
            />
          </div>

          <div
            id="lista-estudiantes"
            class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[320px] overflow-y-auto pr-1"
          >
            <p class="text-slate-400 text-xs">Cargando estudiantes...</p>
          </div>
        </section>

        <!-- ========== SECCI√ìN: TUTOR√çAS ========== -->
        <section id="sec-tutorias" class="hidden space-y-4">
          <h2 class="text-lg font-semibold text-slate-50">Tutor√≠as registradas</h2>
          <div id="lista-tutorias" class="space-y-3 max-h-[350px] overflow-y-auto pr-1">
            <p class="text-slate-400 text-xs">Cargando tutor√≠as...</p>
          </div>
        </section>

        <!-- ========== SECCI√ìN: FEEDBACK ========== -->
        <section id="sec-feedback" class="hidden space-y-4">
          <h2 class="text-lg font-semibold text-slate-50">Retroalimentaciones recibidas</h2>
          <div id="lista-feedback" class="space-y-3 max-h-[350px] overflow-y-auto pr-1">
            <p class="text-slate-400 text-xs">Cargando retroalimentaciones...</p>
          </div>
        </section>

        <!-- ========== SECCI√ìN: REGISTRO ========== -->
        <section id="sec-registro" class="hidden space-y-4">
          <h2 class="text-lg font-semibold text-slate-50">Registrar nueva tutor√≠a</h2>

          <form id="form-registro" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
            <div>
              <label class="block mb-1 text-slate-300">ID Alumno</label>
              <input
                id="reg-id-alumno"
                type="number"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
                placeholder="Ej: 15"
              />
            </div>

            <div>
              <label class="block mb-1 text-slate-300">Fecha y hora</label>
              <input
                id="reg-fecha"
                type="datetime-local"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
              />
            </div>

            <div>
              <label class="block mb-1 text-slate-300">Tipo de tutor√≠a</label>
              <select
                id="reg-tipo"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
              >
                <option value="">Seleccione...</option>
                <option value="Acad√©mica">Acad√©mica</option>
                <option value="Personal">Personal</option>
                <option value="Profesional">Profesional</option>
                <option value="Presencial">Presencial</option>
                <option value="Virtual">Virtual</option>
              </select>
            </div>

            <div>
              <label class="block mb-1 text-slate-300">ID Cronograma (opcional)</label>
              <input
                id="reg-id-crono"
                type="number"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block mb-1 text-slate-300">Observaciones</label>
              <textarea
                id="reg-obs"
                rows="3"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
              ></textarea>
            </div>

            <div class="md:col-span-2">
              <label class="block mb-1 text-slate-300">Derivaciones (si aplica)</label>
              <textarea
                id="reg-der"
                rows="2"
                class="w-full px-3 py-2 rounded-xl bg-slate-900/70 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-sky-400"
              ></textarea>
            </div>

            <div class="md:col-span-2 flex items-center justify-between">
              <span id="reg-msg" class="text-xs font-medium text-emerald-400"></span>
              <button
                type="submit"
                class="px-5 py-2 rounded-xl bg-sky-500 hover:bg-sky-400 text-xs font-semibold text-slate-950 transition shadow-[0_0_20px_rgba(56,189,248,0.5)]"
              >
                Guardar registro
              </button>
            </div>
          </form>
        </section>

      </main>
    </div>
  </div>

  <!-- ==================== SCRIPT ==================== -->
  <script>
    const user = JSON.parse(localStorage.getItem("userData"));
    if (!user || user.rol !== 2) {
      // 2 = Tutor (seg√∫n tu mapa de roles)
      window.location.href = "/";
    }

    document.getElementById("tutor-email").textContent = user.email;

    document.getElementById("logout-btn").addEventListener("click", () => {
      localStorage.removeItem("userData");
      localStorage.removeItem("token");
      window.location.href = "/";
    });

    // ---------- Tabs ----------
    const tabButtons = document.querySelectorAll(".tab-btn");
    const sectionIds = ["sec-estudiantes", "sec-tutorias", "sec-feedback", "sec-registro"];

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;

        sectionIds.forEach(id => {
          document.getElementById(id).classList.toggle("hidden", id !== target);
        });

        tabButtons.forEach(b => {
          b.classList.remove("bg-sky-500/20", "text-sky-300", "border-sky-400/40");
          b.classList.add("bg-slate-950/0", "text-slate-200", "border-transparent");
        });

        btn.classList.add("bg-sky-500/20", "text-sky-300", "border-sky-400/40");
        btn.classList.remove("bg-slate-950/0", "text-slate-200", "border-transparent");
      });
    });

    const API_BASE = "/api/tutor";

    async function fetchJSON(url, options = {}) {
      try {
        const res = await fetch(url, options);
        const data = await res.json();
        if (!res.ok) {
          console.error("Error backend:", data);
          return null;
        }
        return data;
      } catch (e) {
        console.error("Error de conexi√≥n:", e);
        return null;
      }
    }

    // ---------- Estudiantes ----------
    async function cargarEstudiantes() {
      const data = await fetchJSON(`${API_BASE}/students/${user.id}`);
      const cont = document.getElementById("lista-estudiantes");
      cont.innerHTML = "";

      if (!data || !data.students || data.students.length === 0) {
        cont.innerHTML = `<p class="text-slate-400 text-xs">No hay estudiantes registrados.</p>`;
        document.getElementById("count-estudiantes").textContent = "0";
        return;
      }

      document.getElementById("count-estudiantes").textContent = data.students.length;

      const renderLista = (lista) => {
        cont.innerHTML = "";
        lista.forEach(s => {
          const card = document.createElement("div");
          card.className = "rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3";
          card.innerHTML = `
            <p class="text-sm font-semibold text-slate-50">${s.nombre} ${s.apellido}</p>
            <p class="text-[11px] text-slate-400">Programa: ${s.programa_estudio || "-"}</p>
            <p class="text-[11px] text-slate-500 mt-1">
              ID Alumno: ${s.id_alumno} ¬∑ C√≥digo: ${s.codigo_estudiante || "-"}
            </p>
          `;
          cont.appendChild(card);
        });
      };

      renderLista(data.students);

      const searchInput = document.getElementById("search-estudiante");
      searchInput.addEventListener("input", () => {
        const term = searchInput.value.toLowerCase();
        const filtrados = data.students.filter(s =>
          (`${s.nombre} ${s.apellido} ${s.codigo_estudiante || ""}`).toLowerCase().includes(term)
        );
        if (filtrados.length === 0) {
          cont.innerHTML = `<p class="text-slate-400 text-xs">No se encontraron estudiantes.</p>`;
        } else {
          renderLista(filtrados);
        }
      });
    }

    // ---------- Tutor√≠as ----------
    async function cargarTutorias() {
      const data = await fetchJSON(`${API_BASE}/tutorias/${user.id}`);
      const cont = document.getElementById("lista-tutorias");
      cont.innerHTML = "";

      if (!data || !data.tutorias || data.tutorias.length === 0) {
        cont.innerHTML = `<p class="text-slate-400 text-xs">No hay tutor√≠as registradas.</p>`;
        document.getElementById("count-tutorias").textContent = "0";
        return;
      }

      document.getElementById("count-tutorias").textContent = data.tutorias.length;

      data.tutorias.forEach(t => {
        const div = document.createElement("div");
        div.className = "rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2";
        div.innerHTML = `
          <div>
            <p class="text-sm font-semibold text-slate-50">${t.nombre_alumno} ${t.apellido_alumno}</p>
            <p class="text-[11px] text-slate-400">Tipo: ${t.tipo_tutoria || "-"}</p>
            <p class="text-[11px] text-slate-500 mt-1">Obs: ${t.observaciones || "-"}</p>
          </div>
          <p class="text-[11px] text-slate-300">
            ${new Date(t.fecha_tutoria).toLocaleString()}
          </p>
        `;
        cont.appendChild(div);
      });
    }

    // ---------- Feedback ----------
    async function cargarFeedback() {
      const data = await fetchJSON(`${API_BASE}/retro/${user.id}`);
      const cont = document.getElementById("lista-feedback");
      cont.innerHTML = "";

      if (!data || !data.retroalimentaciones || data.retroalimentaciones.length === 0) {
        cont.innerHTML = `<p class="text-slate-400 text-xs">No hay retroalimentaciones.</p>`;
        document.getElementById("count-feedback").textContent = "0";
        return;
      }

      document.getElementById("count-feedback").textContent = data.retroalimentaciones.length;

      data.retroalimentaciones.forEach(r => {
        const div = document.createElement("div");
        div.className = "rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3";
        div.innerHTML = `
          <p class="text-sm font-semibold text-slate-50">${r.nombre} ${r.apellido}</p>
          <p class="text-[11px] text-slate-400 mb-1">${new Date(r.fecha).toLocaleString()}</p>
          <p class="text-xs text-slate-200">${r.comentario}</p>
        `;
        cont.appendChild(div);
      });
    }

    // ---------- Registrar tutor√≠a ----------
    document.getElementById("form-registro").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("reg-msg");
      msg.textContent = "";

      const id_alumno = document.getElementById("reg-id-alumno").value.trim();
      const fecha = document.getElementById("reg-fecha").value;
      const tipo = document.getElementById("reg-tipo").value;
      const id_crono = document.getElementById("reg-id-crono").value.trim();
      const obs = document.getElementById("reg-obs").value.trim();
      const der = document.getElementById("reg-der").value.trim();

      if (!id_alumno || !fecha) {
        msg.textContent = "ID Alumno y Fecha son obligatorios.";
        msg.classList.remove("text-emerald-400");
        msg.classList.add("text-rose-400");
        return;
      }

      const payload = {
        id_tutor: user.id,
        id_alumno: parseInt(id_alumno),
        fecha_tutoria: fecha,
        tipo_tutoria: tipo || null,
        observaciones: obs || null,
        derivaciones: der || null,
        id_cronograma: id_crono ? parseInt(id_crono) : null
      };

      const res = await fetch(`${API_BASE}/registro`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok) {
        msg.textContent = data.message || "Error al guardar el registro.";
        msg.classList.remove("text-emerald-400");
        msg.classList.add("text-rose-400");
      } else {
        msg.textContent = "Registro guardado correctamente.";
        msg.classList.remove("text-rose-400");
        msg.classList.add("text-emerald-400");
        cargarTutorias();
        cargarEstudiantes();
      }
    });

    // Carga inicial
    cargarEstudiantes();
    cargarTutorias();
    cargarFeedback();
  </script>
</body>
</html>
